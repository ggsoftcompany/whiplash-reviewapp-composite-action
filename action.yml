name: 'Whiplash Heroku Review App Deploy'
description: 'Composite action to help Whiplash review app deployment. It will deploy 2 Review App that has dependency between them. For example a backend API and the UI. '
inputs:
  workingDirectoryPath:
    description: 'Default working directory.'
    required: false
    default: ${{github.workspace}}
  github_accessToken:
    description: 'Github access token'
    required: true
    default: ''
  github_repository:
    description: 'The full name of the repository.(owner/repo)'
    required: false
    default: ${{github.repository}}
  github_branchRef:
    description: 'The fully-formed ref of the branch that triggered the workflow run. This is the pull request merge branch. example: refs/pull/<pr_number>/merge'
    required: false
    default: ${{github.ref}}
  github_pullRequestNumber:
    description: 'The '
    required: false
    default: ${{github.event.number}}
  heroku_apiKey:
    description: 'HEROKU API access token'
    required: true
    default: ''
  heroku_pipelineName:
    description: 'The name of the target pipeline in HEROKU'
    required: true
    default: ''
  reviewapp_prefixURL:
    description: 'The prefix URL of the primary Review App'
    required: true
    default: ''
  reviewapp_version:
    description: 'Source code version for the review app. Default to the version number (or SHA) of the code to build.'
    required: false
    default: ${{github.sha}}
  reviewapp_environmentValues:
    description: 'JSON string with environment values to include in the configuration of the primary Review APP. (Optional)'
    required: false
    default: ''
  secondaryHeroku_pipelineName:
    description: 'The name of the secondary review app target pipeline in HEROKU'
    required: true
    default: ''
  secondaryReviewapp_environmentValues:
    description: 'JSON string with environment values to include in the configuration of the secondary Review APP. (Optional)'
    required: false
    default: ''
  secondaryReviewapp_prefixURL:
    description: 'The prefix URL of the secondary Review App'
    required: true
    default: ''
  secondaryReviewapp_newBranchPrefix:
    description: 'The prefix to use in the name of the new branch the script will create based on the SecondaryReviewAppGithubSourceBranch. The Secondary Review App will use this new branch as source code.'
    required: true
    default: ''
  secondaryReviewapp_defaultBranch:
    description: 'The name of the branch to use to create the secondary review app.'
    required: true
    default: ''
outputs:
  reviewapp_URL:
    description: "The URL of the primary Review App"
    value: ${{ steps.create-reviewapp.outputs.reviewapp_URL }}
  secondaryReviewapp_URL:
    description: "The URL of the primary Review App"
    value: ${{ steps.create-reviewapp.outputs.secondaryReviewapp_URL }}
runs:
  using: "composite"
  steps:
    - id: create-reviewapp
      run: ${{ github.action_path }}/scripts/primary-reviewapp-creation.ps1 `
              -workingDirectoryPath '${{inputs.workingDirectoryPath}}' `
              -herokuApiKey '${{inputs.heroku_apiKey}}' `
              -herokuPipelineName '${{inputs.heroku_pipelineName}}' `
              -githubAccessToken '${{inputs.github_accessToken}}' `
              -githubRepositoryFullName '${{inputs.github_repository}}' `
              -githubFullBranchName '${{inputs.github_branchRef}}' `
              -sourceCodeVersion '${{inputs.reviewapp_version}}' `
              -reviewAppPrefixURL '${{inputs.reviewapp_prefixURL}}' `
              -reviewAppEnvironmentValues '${{inputs.reviewapp_environmentValues}}' `
              -secondaryReviewAppPrefixURL '${{inputs.secondaryReviewapp_prefixURL}}' `
              -secondaryReviewAppNewBranchPrefix '${{inputs.secondaryReviewapp_newBranchPrefix}}'
      shell: powershell

    - id: create-secondary-reviewapp
      run: ${{ github.action_path }}/scripts/secondary-reviewapp-creation.ps1 `
              -workingDirectoryPath '${{inputs.workingDirectoryPath}}' `
              -herokuApiKey '${{inputs.heroku_apiKey}}' `
              -herokuPipelineName '${{inputs.secondaryHeroku_pipelineName}}' `
              -githubAccessToken '${{inputs.github_accessToken}}' `
              -githubRepositoryFullName '${{inputs.github_repository}}' `
              -pullRequestNumber '${{inputs.github_pullRequestNumber}}' `
              -primaryReviewAppURL '${{ steps.create-reviewapp.outputs.reviewapp_URL }}' `
              -reviewAppURL '${{ steps.create-reviewapp.outputs.secondaryReviewapp_URL }}' `
              -environmentValues '${{inputs.secondaryReviewapp_environmentValues}}' `
              -githubDefaultBranch '${{ inputs.secondaryReviewapp_defaultBranch }}' `
              -githubNewBranchPrefix '${{inputs.secondaryReviewapp_newBranchPrefix}}'
      shell: powershell
